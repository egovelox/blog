<!doctype html>
<html lang ="en">
  <head>
    
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta description="traditional post">
    <title>Postgres server conf</title>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/modern-normalize/0.5.0/modern-normalize.min.css">
    <link rel="stylesheet" href="./styles/main.css">

    
  </head>
  <body>
  <nav>
        <div class="nav-brand">
            <svg id = "brand" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 245 245"><defs><style>.cls-1{font-size:41px;fill:#fff;font-family:AmericanTypewriter, American Typewriter;}.cls-2{letter-spacing:-0.03em;}</style></defs><title>egovelox</title><g id="Calque_2" data-name="Calque 2"><g id="Calque_1-2" data-name="Calque 1"><rect width="245" height="245"/><text class="cls-1" transform="translate(57.7 130)">EGO<tspan x="0" y="49.2">VEL</tspan><tspan class="cls-2" x="83.56" y="49.2">O</tspan><tspan x="109.02" y="49.2">X</tspan></text></g></g></svg>
        </div>
        <ul id="navbar">
          <li class="nav-item">
            <a href="./index.html">&#9783; Articles</a>
          </li>
          <li class="nav-item">
            <a href="./about.html">About</a>
          </li>
          <li class="nav-item">
            <a href="./index.html">Nugae</a>
          </li>
        </ul>
    </nav>
    
  <article>
    <header>
      <h1>Postgres server conf</h1>
    </header>
    <div class="markdown-body">
      <p>Here is how to configure a PSQL instance on a <strong>CentOS 8</strong> server.</p>
<h2 id="install-from-repo">Install from repo</h2>
<pre><code class="hljs language-bash">yum install postgresql-server postgresql-contrib</code></pre>
<h2 id="getting-the-thing-started">Getting the thing started</h2>
<p>The first time you will try to run postgresql, <strong>you'll get an error !!</strong></p>
<pre><code class="hljs language-bash">sudo service postgresql start</code></pre>
<pre><code class="hljs language-bash"> Directory <span class="hljs-string">"/var/lib/pgsql/data"</span> is missing or empty.
 Use <span class="hljs-string">"/usr/bin/postgresql-setup --initdb"</span>
 to initialize the database cluster.</code></pre>
<p>The reason for this ? A script was run during the install, and, among other tasks, <strong>it created a directory /var/lib/pgsql owned by the user postgres</strong>.</p>
<p>It did not create a cluster though - a single instance of PSQL allows you to manage multiple databases in a so-called cluster - and that's why the /var/lib/pgsql/data folder is still empty.</p>
<p>So at first, always issue this command as sudo :</p>
<pre><code class="hljs language-bash">service postgresql initdb</code></pre>
<p>You can now switch user and get directly the psql command-line...</p>
<pre><code class="hljs language-bash">sudo su - postgres psql</code></pre>
<p>You can issue the query :</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">version</span>();</code></pre>
<p>and this other : </p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_roles;</code></pre>
<p>You're in. Now be safe, just <strong>add a password for the postgres user</strong> :</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> postgres <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'myPassword'</span>;</code></pre>
<p>Let's quit psql (issue command \q) and now check the result of <strong>this init process</strong>. Go in /var/lib/pgsql :</p>
<pre><code class="hljs language-bash">[postgres@egovelox ~]$ ls
backups  data  initdb_postgresql.log

[postgres@egovelox ~]$ cat initdb_postgresql.log
The files belonging to this database system will be owned by user <span class="hljs-string">"postgres"</span>.
This user must also own the server process.

The database cluster will be initialized with locale <span class="hljs-string">"en_US.UTF-8"</span>.
The default database encoding has accordingly been <span class="hljs-built_in">set</span> to <span class="hljs-string">"UTF8"</span>.
The default text search configuration will be <span class="hljs-built_in">set</span> to <span class="hljs-string">"english"</span>.

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/pgsql/data ... ok
creating subdirectories ... ok
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting dynamic shared memory implementation ... posix
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

Success. You can now start the database server using:

    /usr/bin/pg_ctl -D /var/lib/pgsql/data -l logfile start
</code></pre>
<p>To start the PGSQL server, now you can either : </p>
<ol>
<li>as user postgres, run the latter (adding &#x26;) </li>
<li>or just prefer, from your normal account :</li>
</ol>
<pre><code class="hljs language-bash">sudo systemctl start postgresql &#x26;&#x26; systemctl <span class="hljs-built_in">enable</span> postgresql</code></pre>
<p>Fell free to check the "newborn" logfile in /var/lib/pgsql</p>
<pre><code class="hljs language-bash">[postgres@egovelox ~]$ ls
backups  data  initdb_postgresql.log  logfile
[postgres@egovelox ~]$ cat logfile
2020-03-27 04:07:51.750 CET [16656] LOG:  listening on IPv6 address <span class="hljs-string">"::1"</span>, port 5432
2020-03-27 04:07:51.750 CET [16656] LOG:  listening on IPv4 address <span class="hljs-string">"127.0.0.1"</span>, port 5432
2020-03-27 04:07:51.754 CET [16656] LOG:  listening on Unix socket <span class="hljs-string">"/var/run/postgresql/.s.PGSQL.5432"</span>
2020-03-27 04:07:51.762 CET [16656] LOG:  listening on Unix socket <span class="hljs-string">"/tmp/.s.PGSQL.5432"</span>
2020-03-27 04:07:51.773 CET [16656] LOG:  redirecting <span class="hljs-built_in">log</span> output to logging collector process
2020-03-27 04:07:51.773 CET [16656] HINT:  Future <span class="hljs-built_in">log</span> output will appear <span class="hljs-keyword">in</span> directory <span class="hljs-string">"log"</span>.</code></pre>
<h2 id="configure-the-server">Configure the server</h2>
<p>My version of CentOS 8 (but note that it might not always be so) provided <strong>firewalld</strong> by default. So first of all,open PSQL default port (<strong>5432</strong>) : </p>
<pre><code class="hljs language-bash">sudo firewalld-cmd --zone=public --permanent --add-port 5432/tcp 
sudo firewall-cmd --reload</code></pre>
<p>Now we need to configure how PGSQL allows local or distant connections to databases. Two files are needed here, in the <strong>PGSQL instance directory /var/lib/pgsql/data/</strong> : </p>
<ol>
<li><strong>postgresql.conf</strong></li>
<li><strong>pg_hba.conf</strong> (host-based-authentication)</li>
</ol>
<p>First in postgresql.conf, change the directive listen_addresses like this :</p>
<pre><code class="hljs language-bash">listen_addresses = <span class="hljs-string">'*'</span>                  <span class="hljs-comment"># what IP address(es) to listen on;</span>
                                        <span class="hljs-comment"># comma-separated list of addresses;</span>
                                        <span class="hljs-comment"># defaults to 'localhost'; use '*' for all</span>
                                        <span class="hljs-comment"># (change requires restart)</span></code></pre>
<p>Be aware, <strong>here PGSQL needs a restart</strong> : </p>
<pre><code class="hljs language-bash">sudo systemctl restart postgresql</code></pre>
<p>Let's now assume that our machine runs behind a router, with a static address.
Here, using 0.0.0.0/0, PGSQL instance should be able to get a dialog with any machine from the outside, </p>
<ol>
<li>on all databases, </li>
<li>as long as the user is postgres </li>
<li>and password is valid (we use md5 to encrypt it along the wire).</li>
</ol>
<pre><code class="hljs language-bash"><span class="hljs-comment"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span>

<span class="hljs-comment"># "local" is for Unix domain socket connections only</span>
<span class="hljs-built_in">local</span>   all             all                                     peer
<span class="hljs-comment"># IPv4 local connections:</span>
host    all             all             127.0.0.1/32            ident
host    all             postgres        0.0.0.0/0               md5
<span class="hljs-comment"># IPv6 local connections:</span>
host    all             all             ::1/128                 ident
<span class="hljs-comment"># Allow replication connections from localhost, by a user with the</span>
<span class="hljs-comment"># replication privilege.</span>
<span class="hljs-built_in">local</span>   replication     all                                     peer
host    replication     all             127.0.0.1/32            md5
host    replication     all             ::1/128                 md5</code></pre>
<p>Be aware, <strong>here PGSQL needs a reload</strong> : </p>
<pre><code class="hljs language-bash">sudo systemctl reload postgresql</code></pre>
<p><strong>And its'all done</strong> (for the 'basics' of course) ! </p>
<p>Choose safety, in your router map a different port to 5432. Now you'll get remote access to your databases with the following parameters : </p>
<pre><code class="hljs language-bash">user: postgres
passwd : the pass you chose
address : your public IP
port : the port you chose
database : a default one is postgres</code></pre>

    </div>
  </article>

  <script src="//cdnjs.cloudfare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
  <script>
    window
      .hljs
      .initHighlightingOnLoad();
  </script>

    <footer id="footer">&#128736;<span id="footerSignature">egovelox</span> Jan 2020 with &#128420;</footer>
  </body>
</html>